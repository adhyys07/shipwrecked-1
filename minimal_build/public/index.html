<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Time Logger</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    body {
      font-family: 'Press Start 2P', monospace;
      background-image: url('./images/bg.png');
      color: black;
      width: 100vw;
      height: 100vh;
      margin: 0;
      padding: 0;
      overflow: hidden;
      box-sizing: border-box;
    }

    .sidebar {
  position: fixed;
  left: 0;
  top: 0;
  width: 220px;
  height: 100vh;
  background: #181c20;
  color: #fff;
  border-right: 3px solid #00fff7;
  z-index: 100;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  padding: 32px 16px 16px 16px;
  box-sizing: border-box;
  font-family: 'Press Start 2P', monospace;
}

.sidebar h2 {
  font-size: 14px;
  margin-bottom: 24px;
  color: #00fff7;
  letter-spacing: 1px;
}

.sidebar ul {
  list-style: none;
  padding: 0;
  margin: 0;
  width: 100%;
}

.sidebar li {
  margin-bottom: 18px;
  font-size: 12px;
  cursor: pointer;
  padding: 8px 12px;
  border-radius: 6px;
  transition: background 0.2s, color 0.2s;
}

.sidebar li:hover {
  background: #00fff7;
  color: #181c20;
}

.sidebar li.selected-project {
  background: #00fff7;
  color: #181c20;
  font-weight: bold;
  filter: brightness(0.7);
}

    .centered-container {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      height: 100vh;
      width: 100vw;
      padding: 0;
      margin-left: 220px;
    }

    .panel {
      background: white;
      padding: 30px;
      border: 5px solid black;
      border-radius: 0;
      width: 78vw;
      max-width: 1600px;
      min-width: 1250px;
      height: 70vh;
      max-height: 600px;
      min-height: 600px;
      display: flex;
      flex-direction: row;
      align-items: stretch;
      box-sizing: border-box;
      gap: 32px;
      margin-left: 30px;
    }
    
.fairy-lights {
  position: absolute;
  top: -24px;
  left: 0;
  width: 100%;
  height: 0;
  pointer-events: none;
  z-index: 2;
  display: flex;
  justify-content: space-between;
  padding: 0 32px;
}

.fairy-light {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: radial-gradient(circle at 60% 40%, #fff 60%, #fffa 80%, transparent 100%);
  box-shadow:
    0 0 16px 4px #fff7,
    0 0 32px 8px var(--fairy-color, #ff0);
  animation: fairy-blink 2s infinite alternate;
  border: 2px solid #fff4;
}

.fairy-light:nth-child(1)  { --fairy-color: #ffb347; animation-delay: 0s; }
.fairy-light:nth-child(2)  { --fairy-color: #ff6961; animation-delay: 0.2s; }
.fairy-light:nth-child(3)  { --fairy-color: #77dd77; animation-delay: 0.4s; }
.fairy-light:nth-child(4)  { --fairy-color: #84b6f4; animation-delay: 0.6s; }
.fairy-light:nth-child(5)  { --fairy-color: #f49ac2; animation-delay: 0.8s; }
.fairy-light:nth-child(6)  { --fairy-color: #fff68f; animation-delay: 1s; }
.fairy-light:nth-child(7)  { --fairy-color: #b19cd9; animation-delay: 1.2s; }
.fairy-light:nth-child(8)  { --fairy-color: #ffb347; animation-delay: 1.4s; }
.fairy-light:nth-child(9)  { --fairy-color: #ff6961; animation-delay: 1.6s; }
.fairy-light:nth-child(10) { --fairy-color: #77dd77; animation-delay: 1.8s; }

@keyframes fairy-blink {
  0%   { filter: brightness(1.2) drop-shadow(0 0 8px var(--fairy-color, #fff)); }
  100% { filter: brightness(2.2) drop-shadow(0 0 24px var(--fairy-color, #fff)); }
}

    .left-section, .right-section {
      flex: 1 1 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-width: 0;
    }

    .left-section {
      justify-content: center;
      align-items: center;
      border-right: 3px solid #000;
      padding-right: 24px;
    }

    .right-section {
      justify-content: space-between;
      align-items: stretch;
      padding-left: 24px;
      display: flex;
      flex-direction: column;
    }

    h1 {
      text-align: center;
      font-size: 18px;
      margin-bottom: 20px;
      color: black;
      width: 100%;
    }

    label {
      font-size: 10px;
      display: block;
      margin-bottom: 5px;
      margin-top: 10px;
    }

    input, select, textarea {
      font-family: 'Press Start 2P', monospace;
      font-size: 10px;
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      background: #000;
      color: white;
      border: 3px solid white;
      box-sizing: border-box;
      resize: none;
    }

    button {
      font-family: 'Press Start 2P', monospace;
      font-size: 10px;
      width: 100%;
      padding: 12px;
      margin-top: 5px;
      margin-bottom: 15px;
      background-color: #00FFCC;
      color: #000;
      border: 3px solid #000;
      cursor: pointer;
    }

    button:hover {
      background-color: grey;
    }

    #changeApiKeyBtn:hover {
      background-color: #ff5252 !important;
      transform: translate(0.5px, 0.5px);
      box-shadow: 0.5px 0.5px 0px #333 !important;
    }

    #registerNewBtn:hover {
      background-color: #26a69a !important;
      transform: translate(0.5px, 0.5px);
      box-shadow: 0.5px 0.5px 0px #333 !important;
    }

    #clearApiKeyBtn:hover {
      background-color: #cc0000 !important;
      transform: translate(0.5px, 0.5px);
      box-shadow: 0.5px 0.5px 0px #333 !important;
    }

    #timerDisplay {
      text-align: center;
      font-size: 14px;
      font-weight: bold;
      margin: 10px 0;
    }

    #totalhrs {
      text-align: center;
      font-size: 14px;
      font-weight: bold;
      margin: 10px 0;
    }

    ::placeholder {
      color: white;
    }

 .button-row {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-bottom: 15px;
  margin-top: auto;
}

.button-row button {
  flex: 1;
  width: 105px;
  margin: 0;
}

    .wheel-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 10px;
      width: 100%;
      height: 400px;
      position: relative;
      overflow: hidden;
    }

    .wheel {
      width: 420px;
      height: 420px;
      object-fit: contain;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      filter: drop-shadow(0 0 2px #00fff7) drop-shadow(0 0 4px #00fff7);
    }

    .wheel.paused {
      animation-play-state: paused;
    }

    @keyframes spin {
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 900px) {
      .panel {
        flex-direction: column;
        min-width: 0;
        min-height: 0;
        width: 98vw;
        height: auto;
        max-width: 98vw;
        max-height: none;
        gap: 0;
      }
      .left-section, .right-section {
        border: none;
        padding: 0;
      }
      .left-section {
        border-bottom: 3px solid #000;
        padding-bottom: 16px;
        margin-bottom: 16px;
      }
      .right-section {
        padding-top: 0;
        margin-top: 0;
      }
    }

#addProjectDialog {
  display: none;
  position: fixed;
  left: 0;
  top: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.55);
  z-index: 99999;
  align-items: center;
  justify-content: center;
}

#addProjectForm {
  background: #181c20;
  border: 3px solid #00fff7;
  border-radius: 20px;
  box-shadow: 0 12px 40px #000a;
  padding: 48px 48px 32px 48px;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 400px;
  max-width: 96vw;
}

#addProjectForm h3 {
  color: #00fff7;
  margin-bottom: 24px;
  font-size: 20px;
}

#newProjectName {
  width: 100%;
  font-size: 18px;
  padding: 14px;
  margin-bottom: 18px;
  border-radius: 8px;
  border: 2px solid #00fff7;
  background: #222;
  color: #fff;
  outline: none;
}

#newProjectLevel,
#newProjectType,
#newProjectOwner {
  width: 100%;
  font-size: 18px;
  padding: 14px;
  margin-bottom: 18px;
  border-radius: 8px;
  border: 2px solid #00fff7;
  background: #222;
  color: #fff;
  outline: none;
}

#addProjectForm button {
  background: #00fff7;
  color: #181c20;
  border: none;
  border-radius: 8px;
  padding: 14px 32px;
  font-size: 18px;
  font-family: 'Press Start 2P', monospace;
  cursor: pointer;
}

#addProjectForm button[type="button"] {
  background: #333;
  color: #fff;
}
  </style>
</head>
<body>
  <!-- Top Right Clear API Key Button -->
  <div style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
    <button id="clearApiKeyBtn" style="font-family: 'Press Start 2P', monospace; font-size: 8px; padding: 8px 12px; background: #ff4444; color: #fff; border: 2px solid #000; border-radius: 0; cursor: pointer; box-shadow: 2px 2px 0px #333; text-shadow: 1px 1px 0px #000;">
      CLEAR API KEY
    </button>
  </div>
  
  <div class="sidebar">
    <h2>Your Projects</h2>
    <ul id="projectList">
    </ul>
    <button id="addProjectBtn" title="Add Project"style="margin-top:auto; width:40px; height:40px; align-self:center; background:#00fff7; color:#181c20; border:none; border-radius:50%; font-size:28px; font-family:'Press Start 2P',monospace; cursor:pointer; box-shadow:0 2px 8px #00fff799; display:flex; align-items:center; justify-content:center;">
      +
    </button>
  </div>
  <div class="centered-container">
    <div class="fairy-lights">
  <div class="fairy-light"></div>
  <div class="fairy-light"></div>
  <div class="fairy-light"></div>
  <div class="fairy-light"></div>
  <div class="fairy-light"></div>
  <div class="fairy-light"></div>
  <div class="fairy-light"></div>
  <div class="fairy-light"></div>
  <div class="fairy-light"></div>
  <div class="fairy-light"></div>
</div>
    <div class="panel">
      
      <div class="left-section">
        <u><h1>GIANT WHEEL</h1></u>
<div class="wheel-container">
  <img id="giantWheel" src="images/giantwhee2l.gif" alt="Giant Wheel" class="wheel" style="display:none;" />
  <img id="giantWheelStatic" src="images/giantwhee2l.png" alt="Giant Wheel Static" class="wheel" style="display:block;" />
</div>
        <div>
          <span style="font-size: 14px; color: black; font-weight: bold; margin-right: 8px;">Current Session:</span>
          <p id="timerDisplay" style="display: inline-block; margin: 0;">00:00:00</p>
          <br><br>
          <span style="font-size: 14px; color: black; font-weight: bold; margin-right: 8px;">Total Time Enjoyed:</span>
          <span id="totalTimeDisplay" style="font-size: 14px; color: black; font-weight: bold;">00:00:00</span>
        </div>
      </div>
      <div class="right-section">
        <div style="background: #000; padding: 10px; margin-bottom: 15px; border: 2px solid #00fff7; border-radius: 0; box-shadow: 2px 2px 0px #333;">
          <label style="font-size: 7px; color: #00fff7; margin-bottom: 6px; display: block; font-family: 'Press Start 2P', monospace; text-transform: uppercase;">API KEY STATUS:</label>
          <div id="apiKeyStatus" style="font-family: 'Press Start 2P', monospace; font-size: 8px; color: #fff; word-break: break-all; background: #222; padding: 8px; border: 1px solid #00fff7; border-radius: 0; text-shadow: 1px 1px 0px #000; line-height: 1.2;">
            Loading...
          </div>
        </div>
        <div id="logFields" style="display: none;">
          <div class="uploads">
            <label for="photoUpload">UPLOAD PHOTOS:</label>
            <textarea id="photoCDN" rows="2" placeholder="Enter Photos CDN"></textarea>
            <label for="videoUpload">UPLOAD VIDEO:</label>
            <textarea id="videoCDN" rows="2" placeholder="Enter Video CDN"></textarea>
          </div>
          <div class="description">
            <label for="description">PROGRESS DESCRIPTION:</label>
            <textarea id="description" rows="6" placeholder="DESCRIBE YOUR PROGRESS..."></textarea>
          </div>
          <div class="button-row">
            <button id="cancelBtn" onclick="cancelTimer()" style="display: none;">CANCEL</button>
            <button id="startPauseBtn2" onclick="toggleTimer()" style="display: none;">PAUSE/RESUME</button>
          </div>
          <button onclick="submitLog()">SUBMIT LOG</button>
        </div>
        <div class="button-row">
          <button id="startPauseBtn" onclick="toggleTimer()">START LOGGING</button>
        </div>
      </div>
    </div>
  </div>

  <div id="addProjectDialog" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.55); z-index:99999; align-items:center; justify-content:center;">
  <form id="addProjectForm" style="background:#181c20; border:3px solid #00fff7; border-radius:20px; box-shadow:0 12px 40px #000a; padding:48px 48px 32px 48px; display:flex; flex-direction:column; align-items:center; min-width:400px; max-width:96vw;">
    <h3 style="color:#00fff7; margin-bottom:24px; font-size:20px;">New Game Project !</h3>
    <input id="newProjectName" type="text" placeholder="Project Name" style="width:100%; font-size:18px; padding:14px; margin-bottom:18px; border-radius:8px; border:2px solid #00fff7; background:#222; color:#fff; outline:none;" required />
    <select id="newProjectLevel" style="width:100%; font-size:18px; padding:14px; margin-bottom:18px; border-radius:8px; border:2px solid #00fff7; background:#222; color:#fff; outline:none;">
      <option value="" disabled selected>Project Level</option>
      <option value="Beginner">Beginner</option>
      <option value="Intermediate">Intermediate</option>
      <option value="Advanced">Advanced</option>
    </select>
    <select id="newProjectType" style="width:100%; font-size:18px; padding:14px; margin-bottom:18px; border-radius:8px; border:2px solid #00fff7; background:#222; color:#fff; outline:none;">
      <option value="" disabled selected>Project Type</option>
      <option value="individual">Individual</option>
      <option value="club">Club-Meeting</option>
    </select>
    <div style="display:flex; gap:24px; width:100%; justify-content:center;">
      <button type="submit" style="background:#00fff7; color:#181c20; border:none; border-radius:8px; padding:14px 32px; font-size:18px; font-family:'Press Start 2P',monospace; cursor:pointer;">Add</button>
      <button type="button" id="cancelAddProject" style="background:#333; color:#fff; border:none; border-radius:8px; padding:14px 32px; font-size:18px; font-family:'Press Start 2P',monospace; cursor:pointer;">Cancel</button>
    </div>
  </form>
</div>

  <script>
    let startTime = 0;
    let elapsedTime = 0;
    let timerInterval = null;
    let isRunning = false;
    const audio = new Audio('./audio/click.mp3');
    let totalElapsedTime = 0;
    let selectedProject = null;

    function setWheelPaused(paused) {
      document.getElementById("giantWheel").style.display = paused ? "none" : "block";
      document.getElementById("giantWheelStatic").style.display = paused ? "block" : "none";
    }

    setWheelPaused(true);
    
    // Initialize API key status on page load
    updateApiKeyStatus();

    // Add functionality to clear API key button
    document.getElementById('clearApiKeyBtn').onclick = function() {
      if (confirm('Are you sure you want to clear your API key? In future you have to use the same key to load your progress.')) {
        localStorage.removeItem('apiKey');
        updateApiKeyStatus();
        alert('API key cleared successfully!');
        location.reload();
      }
    };

    function toggleTimer() {
      const startPauseBtn = document.getElementById("startPauseBtn");
      const startPauseBtn2 = document.getElementById("startPauseBtn2");
      const cancelBtn = document.getElementById("cancelBtn");
      const logFields = document.getElementById("logFields");
      audio.play();

      if (!isRunning) {
        // Disable project selection visually
        projectList.style.pointerEvents = 'none';
        projectList.style.opacity = '0.5';
        startTime = Date.now() - elapsedTime;
        timerInterval = setInterval(updateTimer, 1000);
        isRunning = true;
        startPauseBtn.style.display = "none";
        startPauseBtn2.style.display = "block";
        startPauseBtn2.innerText = "PAUSE LOGGING";
        cancelBtn.style.display = "block";
        logFields.style.display = "block";
        updateApiKeyStatus();
        setWheelPaused(false);
      } else {
        // Enable project selection
        projectList.style.pointerEvents = '';
        projectList.style.opacity = '';
        clearInterval(timerInterval);
        elapsedTime = Date.now() - startTime;
        isRunning = false;
        startPauseBtn2.innerText = "RESUME LOGGING";
        setWheelPaused(true);
      }
    }

    function updateApiKeyStatus() {
      const apiKey = localStorage.getItem('apiKey');
      const statusDiv = document.getElementById('apiKeyStatus');
      if (apiKey) {
        statusDiv.innerHTML = `<span style="color: green;">✓ Active:</span> ${apiKey}`;
      } else {
        statusDiv.innerHTML = `<span style="color: red;">✗ No API Key Set</span>`;
      }
    }

    function updateTimer() {
      const currentTime = Date.now();
      elapsedTime = currentTime - startTime;

      const hrs = Math.floor(elapsedTime / 3600000).toString().padStart(2, '0');
      const mins = Math.floor((elapsedTime % 3600000) / 60000).toString().padStart(2, '0');
      const secs = Math.floor((elapsedTime % 60000) / 1000).toString().padStart(2, '0');

      document.getElementById("timerDisplay").innerText = `${hrs}:${mins}:${secs}`;
    }

    function cancelTimer() {
      if (!confirm("Are you sure you want to cancel this session? Time from this session will NOT be added to your total!")) {
        return;
      }
      clearInterval(timerInterval);
      timerInterval = null;
      isRunning = false;
      startTime = 0;
      elapsedTime = 0;

      // Enable project selection
      projectList.style.pointerEvents = '';
      projectList.style.opacity = '';

      document.getElementById("timerDisplay").innerText = "00:00:00";
      document.getElementById("startPauseBtn").style.display = "block";
      document.getElementById("startPauseBtn").innerText = "START LOGGING";
      document.getElementById("startPauseBtn2").style.display = "none";
      document.getElementById("cancelBtn").style.display = "none";
      document.getElementById("logFields").style.display = "none";
      setWheelPaused(true);
      audio.play();
    }

    function updateTotalTimeDisplay() {
      const total = totalElapsedTime;
      const hrs = Math.floor(total / 3600000).toString().padStart(2, '0');
      const mins = Math.floor((total % 3600000) / 60000).toString().padStart(2, '0');
      const secs = Math.floor((total % 60000) / 1000).toString().padStart(2, '0');
      document.getElementById("totalTimeDisplay").innerText = `${hrs}:${mins}:${secs}`;
    }

    async function submitLog() {
      audio.play();
      const photosCDN = document.getElementById("photoCDN").value.trim();
      const videoCDN = document.getElementById("videoCDN").value.trim();
      const timeSpent = document.getElementById("timerDisplay").innerText;
      const description = document.getElementById("description").value.trim();
      const apiKey = localStorage.getItem('apiKey');

      if (!apiKey) {
        alert("API key missing. Please register and enter your API key.");
        showModal('registerModal');
        return;
      }
      if (!selectedProject) {
        alert("Please select a project to log time.");
        return;
      }
      if (!photosCDN) {
        alert("Photo link is required.");
        return;
      }
      if (!videoCDN) {
        alert("Video link is required.");
        return;
      }
      if (!description) {
        alert("Description is required.");
        return;
      }

      // Confirm submission
      if (!confirm(`Are you sure want to submit this log?`)) {
        return;
      }

      const data = {
        timeSpent,
        description,
        photosCDN,
        videoCDN,
        apiKey,
        pname: selectedProject
      };

      try {
        const response = await fetch('/api/log-time', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await response.json();
        if (response.ok) {
          alert("✅ LOG SUBMITTED!");
          document.getElementById("photoCDN").value = "";
          document.getElementById("videoCDN").value = "";
          document.getElementById("description").value = "";
          // Add current session duration to totalElapsedTime
          totalElapsedTime += elapsedTime;
          updateTotalTimeDisplay();
          // After log, refresh total time for the selected project
          fetchAndDisplayTotalTime(selectedProject);
          // Reset current session timer
          clearInterval(timerInterval);
          timerInterval = null;
          isRunning = false;
          startTime = 0;
          elapsedTime = 0;
          // Enable project selection
          projectList.style.pointerEvents = '';
          projectList.style.opacity = '';
          document.getElementById("timerDisplay").innerText = "00:00:00";
          document.getElementById("startPauseBtn").style.display = "block";
          document.getElementById("startPauseBtn").innerText = "START LOGGING";
          document.getElementById("startPauseBtn2").style.display = "none";
          document.getElementById("cancelBtn").style.display = "none";
          document.getElementById("logFields").style.display = "none";
          setWheelPaused(true);
        } else {
          alert(`❌ ERROR: ${result.error}`);
        }
      } catch (err) {
        console.error("❌ Submission failed:", err);
        alert("❌ Failed to submit log. See console.");
      }
    }

    const projectList = document.getElementById('projectList');
    // Highlight selected project and fetch total time
    projectList.addEventListener('click', function(e) {
      if (isRunning) {
        alert('Cannot switch projects while time logging is active!');
        return;
      }
      if (e.target.tagName === 'LI' && !e.target.classList.contains('no-project')) {
        // Remove selection from all
        Array.from(projectList.children).forEach(li => li.classList.remove('selected-project'));
        // Add selection to clicked
        e.target.classList.add('selected-project');
        selectedProject = e.target.textContent;
        fetchAndDisplayTotalTime(selectedProject);
      }
    });

    // Fetch and display total time for a project
    async function fetchAndDisplayTotalTime(pname) {
      const apiKey = localStorage.getItem('apiKey');
      if (!apiKey || !pname) return;
      try {
        const res = await fetch(`/api/project-total-time?pname=${encodeURIComponent(pname)}&apiKey=${encodeURIComponent(apiKey)}`);
        const data = await res.json();
        if (res.ok && typeof data.totalTime === 'number') {
          totalElapsedTime = data.totalTime;
          updateTotalTimeDisplay();
        } else {
          totalElapsedTime = 0;
          updateTotalTimeDisplay();
        }
      } catch (err) {
        totalElapsedTime = 0;
        updateTotalTimeDisplay();
      }
    }

    document.getElementById('addProjectBtn').onclick = function() {
      document.getElementById('addProjectDialog').style.display = 'flex';
      document.getElementById('newProjectName').value = '';
      document.getElementById('newProjectLevel').selectedIndex = 0;
      document.getElementById('newProjectType').selectedIndex = 0;
      document.getElementById('newProjectName').focus();
    };

    document.getElementById('cancelAddProject').onclick = function() {
      document.getElementById('addProjectDialog').style.display = 'none';
    };

    document.getElementById('addProjectForm').onsubmit = async function(e) {
      e.preventDefault();
      const name = document.getElementById('newProjectName').value.trim();
      const level = document.getElementById('newProjectLevel').value;
      const type = document.getElementById('newProjectType').value;
      const apiKey = localStorage.getItem('apiKey');
      if (!name || !level || !type) {
        alert('All fields are required to create a project.');
        return;
      }
      if (!apiKey) {
        alert('You must be registered and logged in to create a project.');
        return;
      }
      const createdAt = new Date().toISOString();
      try {
        const response = await fetch('/api/create-project', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, type, level, apiKey, createdAt })
        });
        const result = await response.json();
        if (response.ok) {
          const li = document.createElement('li');
          li.textContent = name;
          document.getElementById('projectList').appendChild(li);
          document.getElementById('addProjectDialog').style.display = 'none';
          const nav = document.querySelector('nav');
          if (nav) {
            const navItem = document.createElement('span');
            navItem.textContent = name;
            navItem.style.marginLeft = '18px';
            navItem.style.color = '#00fff7';
            navItem.style.fontWeight = 'bold';
            nav.appendChild(navItem);
          }
          alert('Project created successfully!');
          location.reload();
        } else {
          alert(result.error || 'Failed to create project.');
        }
      } catch (err) {
        alert('Network error while creating project.');
      }
    };

    window.addEventListener('DOMContentLoaded', function() {
      // Disable start logging button until projects are loaded
      const startPauseBtn = document.getElementById('startPauseBtn');
      startPauseBtn.disabled = true;
      startPauseBtn.style.opacity = '0.5';

      function showModal(id) {
        document.getElementById(id).style.display = 'flex';
      }
      function hideModal(id) {
        document.getElementById(id).style.display = 'none';
      }

      // Fetch and render projects for the logged-in user
      async function loadProjects() {
        const apiKey = localStorage.getItem('apiKey');
        const projectList = document.getElementById('projectList');
        projectList.innerHTML = '';
        let hasProjects = false;
        if (!apiKey) return;
        try {
          const res = await fetch(`/api/projects?apiKey=${encodeURIComponent(apiKey)}`);
          const data = await res.json();
          if (res.ok && Array.isArray(data.projects)) {
            console.log('Fetched projects:', data.projects); // Debug log
            if (data.projects.length === 0) {
              const li = document.createElement('li');
              li.textContent = 'No projects found.';
              li.classList.add('no-project');
              li.style.color = '#888';
              li.style.fontStyle = 'italic';
              projectList.appendChild(li);
              selectedProject = null;
              totalElapsedTime = 0;
              updateTotalTimeDisplay();
              // Show modal to force project creation
              setTimeout(() => {
                alert('You must create a project before you can log time.');
                document.getElementById('addProjectDialog').style.display = 'flex';
              }, 500);
              // Disable log fields and start logging button
              document.getElementById('startPauseBtn').disabled = true;
              document.getElementById('startPauseBtn').style.opacity = '0.5';
            } else {
              hasProjects = true;
              document.getElementById('startPauseBtn').disabled = false;
              document.getElementById('startPauseBtn').style.opacity = '';
              data.projects.forEach((proj, idx) => {
                const li = document.createElement('li');
                li.textContent = proj.name || '[No Name]';
                projectList.appendChild(li);
                if (idx === 0) {
                  li.classList.add('selected-project');
                  selectedProject = li.textContent;
                  fetchAndDisplayTotalTime(selectedProject);
                }
              });
            }
          } else {
            const li = document.createElement('li');
            li.textContent = 'Failed to load projects.';
            li.classList.add('no-project');
            li.style.color = 'red';
            projectList.appendChild(li);
            selectedProject = null;
            totalElapsedTime = 0;
            updateTotalTimeDisplay();
            document.getElementById('startPauseBtn').disabled = true;
            document.getElementById('startPauseBtn').style.opacity = '0.5';
          }
        } catch (err) {
          const li = document.createElement('li');
          li.textContent = 'Error loading projects.';
          li.classList.add('no-project');
          li.style.color = 'red';
          projectList.appendChild(li);
          selectedProject = null;
          totalElapsedTime = 0;
          updateTotalTimeDisplay();
          document.getElementById('startPauseBtn').disabled = true;
          document.getElementById('startPauseBtn').style.opacity = '0.5';
        }
      }
      // Call on load
      loadProjects();

      if (!localStorage.getItem('apiKey')) {
        showModal('registerModal');
      }

      document.getElementById('registerForm').onsubmit = async function(e) {
        e.preventDefault();
        const id = document.getElementById('registerID').value.trim();
        const email = document.getElementById('registerEmail').value.trim();
        const msg = document.getElementById('registerMsg');
        msg.style.display = 'none';
        if (!id) {
          msg.style.display = 'block';
          msg.style.color = 'red';
          msg.innerText = 'Slack ID is required.';
          alert('Slack ID is required.');
          return;
        }
        if (!email) {
          msg.style.display = 'block';
          msg.style.color = 'red';
          msg.innerText = 'Email is required.';
          alert('Email is required.');
          return;
        }
        try {
          const res = await fetch('/api/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, email })
          });
          const result = await res.json();
          if (res.ok) {
            msg.style.display = 'block';
            msg.style.color = 'green';
            msg.innerText = 'API key sent to your email!';
            setTimeout(() => {
              hideModal('registerModal');
              showModal('apiKeyModal');
            }, 1500);
          } else {
            msg.style.display = 'block';
            msg.style.color = 'red';
            msg.innerText = result.error || 'Registration failed.';
          }
        } catch (err) {
          msg.style.display = 'block';
          msg.style.color = 'red';
          msg.innerText = 'Network error.';
        }
      };

      document.getElementById('apiKeyForm').onsubmit = async function(e) {
        e.preventDefault();
        const apiKey = document.getElementById('apiKeyInput').value.trim();
        const msg = document.getElementById('apiKeyMsg');
        msg.style.display = 'none';
        try {
          const res = await fetch('/api/validate-key', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ apiKey })
          });
          const result = await res.json();
          if (res.ok && result.valid) {
            localStorage.setItem('apiKey', apiKey);
            hideModal('apiKeyModal');
            alert('API key saved! You can now log your hours.');
            location.reload();
          } else {
            msg.style.display = 'block';
            msg.innerText = 'Invalid API key.';
          }
        } catch (err) {
          msg.style.display = 'block';
          msg.innerText = 'Network error.';
        }
      };

      document.getElementById('alreadyHaveApiKey').onclick = function(e) {
        e.preventDefault();
        hideModal('registerModal');
        showModal('apiKeyModal');
      };

      function updateApiKeyDebug() {
        const val = localStorage.getItem('apiKey') || '(none)';
        document.getElementById('apiKeyDebugValue').textContent = val;
      }
      updateApiKeyDebug();

      document.getElementById('clearApiKeyBtn').onclick = function() {
        if (confirm('Are you sure you want to clear your API key? You will need to register again to log hours.')) {
          localStorage.removeItem('apiKey');
          updateApiKeyStatus();
          alert('API key cleared successfully!');
        }
      };

      const origSetItem = localStorage.setItem;
      localStorage.setItem = function(key, value) {
        origSetItem.apply(this, arguments);
        if (key === 'apiKey') {
          updateApiKeyDebug();
          updateApiKeyStatus();
        }
      };
    });
  </script>

<div id="registerModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:99999; align-items:center; justify-content:center;">
  <form id="registerForm" style="background:#fff; padding:32px; border-radius:12px; display:flex; flex-direction:column; align-items:center; min-width:320px;">
    <h3>Register to Get API Key</h3>
    <input id="registerID" type="text" placeholder="Enter your Slack ID" required style="margin-bottom:18px; width:100%; padding:10px;">
    <input id="registerEmail" type="email" placeholder="Enter your email" required style="margin-bottom:18px; width:100%; padding:10px;">
    <button type="submit" style="padding:10px 24px;">Register</button>
    <div id="registerMsg" style="margin-top:12px; color:green; display:none;"></div>
    <div style="margin-top:10px;">
      <a href="#" id="alreadyHaveApiKey" style="font-size:12px; color:black; text-decoration:underline; cursor:pointer;">
        Already have an API key?
      </a>
    </div>
  </form>
</div>
<div id="apiKeyModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:99999; align-items:center; justify-content:center;">
  <form id="apiKeyForm" style="background:#fff; padding:32px; border-radius:12px; display:flex; flex-direction:column; align-items:center; min-width:320px;">
    <h3>Enter Your API Key</h3>
    <input id="apiKeyInput" type="text" placeholder="Paste your API key" required style="margin-bottom:18px; width:100%; padding:10px;">
    <button type="submit" style="padding:10px 24px;">Submit</button>
    <div id="apiKeyMsg" style="margin-top:12px; color:red; display:none;"></div>
  </form>
</div>
</body>
</html>